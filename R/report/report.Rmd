---
title: "Análise dos resultados do IDEB da 1° à 5° série da rede pública entre 2005 e 2019"
output: github_document
---

```{r, include = FALSE}

knitr::opts_chunk$set(
  echo = FALSE,
  warning = FALSE,
  message = FALSE
)

```


### Hipóteses primárias

1. O desempenho do sistema educacional dos municípios brasileiros
evoluiram em taxas de variação semelhantes

### Hipóteses secundárias

1.1 O desempenho no Sistema de Avaliação da Educação Básica (Saeb) ddos municípios brasileiros evoluiram em taxas de variação semelhantes

1.2 O fluxo escolar dos municípios brasileiros evoluiram em taxas
de variação semelhantes

```{r load_packages}
library(ggplot2)
library(ggridges)
library(brazilmaps)
library(sf)
```


```{r load_data, warning=FALSE}
load_data_file <- here::here("R", "load_data.R")

source(load_data_file)
```

### Visão geral 

```{r}
df_ideb_score %>%
  filter(ideb_score_status == "Observado") %>%
  ggplot(aes(x = ideb_score, 
             y = ideb_publication_year, 
             fill = ideb_publication_year)) +
  geom_density_ridges(stat = "binline", alpha = 0.6) +
  theme_minimal() +
  theme(legend.position = "none")
```

A partir do histograma acima percebe-ce uma tendência de crescimento do desempenho escolar no território brasileiro,
no entanto esse crescimento vem acompanhado de maior variação nos
dados observados. Outrossim, é notório a presença de mais de uma moda na distribuição dessa variável durante todo período de 2005 à 2019, embora neste último ano os valores tendam para pontuações maiores.

```{r}
counties_map <- get_brmap("City") 
```

```{r}
ideb_counties_map <- counties_map %>%
  mutate(City = as.character(City)) %>%
  left_join(df_ideb_score,
            by = c("City" = "county_id"))
```


```{r echo=FALSE}
ideb_counties_map %>%
  filter(ideb_score_status == "Observado") %>%
  ggplot() +
  geom_sf(aes(fill = ideb_score),
          colour = "transparent", size = 0.1) +
  scale_fill_continuous(type = "viridis") +
  facet_wrap(~ideb_publication_year) +
  theme(panel.grid = element_line(colour = "transparent"),
        panel.background = element_blank(),
        axis.text = element_blank(),
        axis.ticks = element_blank())
```
Segmentando por município e por ano de publicação do IDEB é possível observar a melhoria do desempenho do sistema educacional nos anos inicias do enisno fundamental. Em 2005 existia uma predominância nacional da pontuação entre 2.5 e 5 no IDEB, somente parte dos territórios da região centro-oeste, sudeste e sul alcançaram indicadores acima de 5. Nos anos sucessores, ocorre o espalhamento dessa pontuação, embora ainda restrito às regiões supracitadas.No entanto, em contrapartida aos seus vizinhos, os municípios Cearences ganham maior representatividade nessa faixa de desempenho (entre 5 e 7.5), fenômeno este que se acentua a partir do IDEB de 2011. 
Para uma visualização melhor dessa suposta discrepância do desempenho do sistema educacional nos munícipios brasileiros, é necessário obter uma medida suavizada baseada nos seus vizinhos. A fim de alcançar esse objetivo utilizou-se a regra de contiguidade da rainha de primeira ordem. 

```{r get_ideb_spatial_lag}
get_ideb_spatial_lag_dir <- here::here("R", "get_ideb_spatial_lag.R")

source(get_ideb_spatial_lag_dir)
```

```{r}
ideb_counties_map_queen_weights %>%
  ggplot() +
  geom_sf(aes(geometry = geometry, fill = ideb_score_lag),
          colour = "transparent", size = 0.1) +
  scale_fill_continuous(type = "viridis") +
  facet_wrap(~ideb_publication_year) +
  theme(panel.grid = element_line(colour = "transparent"),
        panel.background = element_blank(),
        axis.text = element_blank(),
        axis.ticks = element_blank())
```

Temos que a pontuação do IDEB suavizada pelos vizinhos apresentam uma predominância de notas acima de 6 nas regiões sudestes e no
estado do Ceará, o que corroborá a análise acima a partir dos dados não suavizados. Especialmente o estado cearense apresenta uma distância em termos de desempenho escolar muito além dos seus vizinhos. Diante disso, o diagrama de espalhamento de Moran pode auxiliar na visualização desses valores extremos que não seguem o mesmo processo de dependência espacial.


```{r}
ideb_counties_map_queen_weights %>%
  ggplot(aes(x = ideb_score, y = ideb_score_lag)) +
  geom_point() +
  geom_smooth(method = "lm") +
  geom_vline(xintercept = mean(ideb_counties_map_queen_weights$ideb_score, na.rm = TRUE),
             color = "red", linetype = "dashed") +
  geom_hline(yintercept = mean(ideb_counties_map_queen_weights$ideb_score_lag, na.rm = TRUE), color = "red", linetype = "dashed") +
  facet_wrap(~ideb_publication_year) +
  labs(y = "Média do desempenho no IDEB em relação aos vizinhos",
       x = "desempenho no IDEB")
```

A partir do diagrama de espalhamento de Moran é possível deduzir dois fenomenos característicos da dependência espacial do desempenho no IDEB. A primeira está relacionada a "diferença" entre o desempenho médio dos vizinhos, caracterizado pela reta de regressão, e o valor observado do IDEB. Outrossim, uma vez traçadas as retas médias de ambas variáveis relacionadas, o diagrama pode ser subdividido segundo quatro grupos, por exemplo, o quadrante que possui municípios com desempenho no IDEB acima da média e vizinhos igualmente acima da médio são considerados "altos" entre "altos", interpretação semelhante aos quadrantes restantes. Dito isso, fica nítido o movimento de ascendência do desempenho escolar no Brasil durante o período analisado, pois em 2005 os municípios encontravam-se predominantemente no quadrante de baixos entre baixos e em 2019 encontram-se a maioria de altos entre altos. No entanto, embora o crescimento da pontuação, observa-se a presença de pontos distantes negativamente dos seus vizinhos, caracterizando menor semelhança entre eles. 

Ainda, cabe analisar o índice global de Moran entre 2005 e 2019, o qual mensura o grau efetivo de dependência espacial. 

```{r}
ideb_counties_map_queen_weights %>%
  group_by(ideb_publication_year) %>%
  drop_na() %>%
  summarise(global_moran_index = cor(ideb_score, ideb_score_lag, method = "pearson")) %>%
  ggplot(aes(x = ideb_publication_year, y = global_moran_index)) +
  geom_point() +
  geom_segment(aes(x = ideb_publication_year,
                   xend = ideb_publication_year,
                   y = .8,
                   yend = global_moran_index))

```

Nesse cenário, o índice global de Moran está acima de 0.8 em todas edições, considerado alta dependência espacial. O indicador atingiu seu pico na edição de 2011 do IDEB, embora após esse período seguiu registrando queda constante até 2019, ano de menor dependência espacial. Ademais, relacionando com as análises anteriores, a publicação com menor dependência espacial também foi aquela com maior participação de municípios nos melhores quadrantes do diagrama. 

```{r}
ideb_counties_map_queen_weights %>%
  ggplot() +
  geom_sf(aes(geometry = geometry, fill = moran_status),
          colour = "transparent", size = 0.1) +
  facet_wrap(~ideb_publication_year) +
  scale_fill_brewer(palette = "RdYlBu") +
  theme(panel.grid = element_line(colour = "transparent"),
        panel.background = element_blank(),
        axis.text = element_blank(),
        axis.ticks = element_blank())
```

Visualizando geograficamente o diagrama de espalhamento de Moran, somos capazes de identificar pelo menos três regiões com desempenho IDEB semelhantes, são elas: a região norte e nordeste, exceto Ceará, formada por territórios de baixa performace com vizinhos de baixo desempenho, seguidamente, a região sudeste e parcialmente a região sul e centro-oeste com alta pontuação no IDEB e vizinhos igualmente altamente performáticos, por último, um caso a ser estudado mais profundamente, o estado Cearence destaque-se tanto na própria região nordeste quanto numa escala nacional, representando uma "ilha" de alto desempenho escolar nos anos iniciais do fundamental. 

### Fluxo escolar

```{r}
df_pass_rate %>%
  group_by(county_id, ideb_publication_year) %>%
  summarise(mean_pass_rate = mean(pass_rate, na.rm = TRUE)) %>%
  ggplot(aes(x = mean_pass_rate, 
             y = ideb_publication_year, 
             fill = ideb_publication_year)) +
  geom_density_ridges(stat = "binline", alpha = 0.6) +
  theme_minimal() +
  theme(legend.position = "none") +
  labs(x = "Média da taxa de aprovação", y = "Ano de publicação do IDEB")
```
```{r}
df_pass_rate %>%
  ggplot(aes(x = pass_rate, 
             y = ideb_publication_year, 
             fill = elementary_school_nd_grade)) +
  geom_density_ridges(stat = "binline", alpha = 0.6) +
  facet_wrap(~elementary_school_nd_grade) +
  theme_minimal() +
  theme(legend.position = "none") +
  labs(x = "Taxa de aprovação", y = "Ano de publicação do IDEB")
```

```{r}
pass_rate_counties_map <- counties_map %>%
  mutate(City = as.character(City)) %>%
  left_join(df_pass_rate,
            by = c("City" = "county_id"))
```

```{r}
pass_rate_mean_counties <- df_pass_rate %>%
  group_by(county_id, ideb_publication_year) %>%
  summarise(mean_pass_rate = mean(pass_rate, na.rm = TRUE))
```

```{r}
pass_rate_mean_counties_map <- counties_map %>%
  mutate(City = as.character(City)) %>%
  left_join(pass_rate_mean_counties,
            by = c("City" = "county_id"))
  
```


```{r echo=FALSE}
pass_rate_mean_counties_map  %>%
  ggplot() +
  geom_sf(aes(fill = mean_pass_rate),
          colour = "transparent", size = 0.1) +
  scale_fill_continuous(type = "viridis") +
  facet_wrap(~ideb_publication_year) +
  theme(panel.grid = element_line(colour = "transparent"),
        panel.background = element_blank(),
        axis.text = element_blank(),
        axis.ticks = element_blank())
```

### Referências

1. https://spatialanalysis.github.io/lab_tutorials/Applications_of_Spatial_Weights.html 

2. https://mgimond.github.io/Spatial/spatial-autocorrelation-in-r.html
